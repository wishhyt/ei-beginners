abstract
1. 旋转矩阵
2. 齐次变换矩阵
3. 欧拉角
4. 四元数

# 坐标变换原理

## 1) 坐标系、向量，以及“主动/被动”视角

* 一个三维向量 $\mathbf{p}$ 的坐标值依赖于**参考坐标系** $\{A\}$ 或 $\{B\}$。
* **主动（active）**变换：把“物体/向量”旋转或平移（坐标系不动）。
  **被动（passive）**变换：换一个“观察坐标系”（物体不动）。
  二者数值上常用**同一个矩阵**，但组合顺序相反，易混淆——写公式时务必**先约定清楚含义**。

---

## 2) 旋转矩阵 $R\in SO(3)$

* **定义与性质**

  $$
  R^TR=I,\quad \det(R)=1
  $$

  它表示三维纯旋转（不含缩放/剪切）。

* **作用（主动视角）**
  给定某向量 $\mathbf{x}$，旋转后

  $$
  \mathbf{y}=R\,\mathbf{x}.
  $$

* **组合与逆**

  $$
  R_{ac}=R_{ab}R_{bc},\quad R^{-1}=R^T.
  $$

* **基本轴旋转**

  $$
  R_x(\alpha)=
  \begin{bmatrix}
  1&0&0\\
  0&\cos\alpha&-\sin\alpha\\
  0&\sin\alpha&\cos\alpha
  \end{bmatrix},\;
  R_y(\beta)=
  \begin{bmatrix}
  \cos\beta&0&\sin\beta\\
  0&1&0\\
  -\sin\beta&0&\cos\beta
  \end{bmatrix},\;
  R_z(\gamma)=
  \begin{bmatrix}
  \cos\gamma&-\sin\gamma&0\\
  \sin\gamma&\cos\gamma&0\\
  0&0&1
  \end{bmatrix}.
  $$

* **轴–角（Rodrigues 公式）**
  若绕单位轴 $\mathbf{n}$ 旋转角 $\theta$，

  $$
  R = I + \sin\theta\,[\mathbf{n}]_\times + (1-\cos\theta)\,[\mathbf{n}]_\times^2,
  $$

  其中
  $[\mathbf{n}]_\times=
  \begin{bmatrix}
  0&-n_z&n_y\\
  n_z&0&-n_x\\
  -n_y&n_x&0
  \end{bmatrix}.$

---

## 3) 齐次变换矩阵 $T\in SE(3)$

* **定义**（把旋转和平移写成一个 4×4 矩阵）：

  $$
  T=\begin{bmatrix}
  R & \mathbf{t}\\
  \mathbf{0}^T & 1
  \end{bmatrix},\quad
  \tilde{\mathbf{p}}=\begin{bmatrix}\mathbf{p}\\1\end{bmatrix}.
  $$

  主动作用：$\tilde{\mathbf{p}}' = T\,\tilde{\mathbf{p}}\Rightarrow \mathbf{p}'=R\mathbf{p}+\mathbf{t}.$

* **组合与逆**

  $$
  T_{ac}=T_{ab}T_{bc},\quad
  T^{-1}=
  \begin{bmatrix}
  R^T & -R^T\mathbf{t}\\
  \mathbf{0}^T & 1
  \end{bmatrix}.
  $$

* **顺序很重要**
  $T_{\text{rot}}(\!R\!)\,T_{\text{trans}}(\mathbf{t}) \neq T_{\text{trans}}(\mathbf{t})\,T_{\text{rot}}(\!R\!)$。
  若先平移再绕**全局原点**旋转，总变换为 $T= T_{\text{rot}}\,T_{\text{trans}}$。

* **与你的示意图一致的构造思想**
  通过“**先把原点移到**$\{C\}$（平移 $\mathbf{t}$），再**对齐坐标轴**到 $\{B\}$（旋转 $R$）”，即可得到

  $$
  T=\begin{bmatrix}R&\mathbf{t}\\0&1\end{bmatrix}.
  $$

  组合多个中间坐标系时，按路径把相应 $T$ **相乘**即可。

---

## 4) 欧拉角（以常见 ZYX = Yaw–Pitch–Roll 为例）

* **定义与构造**

  $$
  R(\psi,\theta,\phi)=R_z(\psi)\,R_y(\theta)\,R_x(\phi),
  $$

  其中 $\psi=$Yaw，$\theta=$Pitch，$\phi=$Roll。**注意：欧拉角的轴序很多**（ZXZ、XYZ…），一定要和软件/文档保持一致。

* **优缺点**

  * 优点：**直观**、便于人机交互与约束（如“航向角 $\in[-\pi,\pi]$”）。
  * 缺点：存在**万向节锁**（如 ZYX 在 $\theta=\pm \frac{\pi}{2}$ 时丢失一个自由度）、角度不唯一、数值优化时**导数不稳定**。

---

## 5) 四元数 $q=[w,\;x,\;y,\;z]$（单位四元数）

* **与轴–角等价**

  $$
  w=\cos\frac{\theta}{2},\quad
  \mathbf{v}=[x,y,z]^T=\mathbf{n}\,\sin\frac{\theta}{2},\quad \|q\|=1.
  $$

* **用四元数旋转向量（主动）**

  $$
  \mathbf{p}'=R(q)\,\mathbf{p}=q\otimes [0,\mathbf{p}] \otimes q^{-1},
  $$

  其中 $\otimes$ 为 Hamilton 乘法，$q^{-1}=[w,-x,-y,-z]$（单位四元数）。

* **由四元数到旋转矩阵**

  $$
  R(q)=\begin{bmatrix}
  1-2(y^2+z^2) & 2(xy-wz) & 2(xz+wy)\\
  2(xy+wz) & 1-2(x^2+z^2) & 2(yz-wx)\\
  2(xz-wy) & 2(yz+wx) & 1-2(x^2+y^2)
  \end{bmatrix}.
  $$


---

## 6) 常见表示之间的转换

* **$R \leftrightarrow$ 轴–角**

  * $R\to(\mathbf{n},\theta)$：
    $\theta=\arccos\!\big(\tfrac{\operatorname{tr}(R)-1}{2}\big)$；
    $\mathbf{n}=\frac{1}{2\sin\theta}\,[R-R^T]^\vee$（$^\vee$ 把反对称矩阵还原为向量）。
  * $(\mathbf{n},\theta)\to R$：用 Rodrigues 公式。

* **$R \leftrightarrow q$**
  见上式与其逆（根据 $\operatorname{tr}(R)$ 分支计算 $w$, 再求 $[x,y,z]$）。

* **欧拉角 $\leftrightarrow R$**
  按选定轴序依次乘基本旋转即可；逆转换按同一轴序反解（注意定义域与奇异姿态）。

---

### 小结

* **姿态**：$R$、欧拉角、四元数（相互可换，各有利弊）。
* **位姿**：齐次矩阵 $T=[R\,|\,\mathbf{t}]$；可**稳定组合/求逆**，是机器人运动学与视觉几何的“通用语”。
* 工程上常用：**内部用 $R/q$** 做计算与插值，**外部用欧拉角**做显示与人机交互。


---

用小段代码验证一下，在简单的情况下，是可以互相转换的。
```python
import numpyasnp
fromscipy.spatial.transform import Rotation as R
# 定义绕 z 轴旋转45度的旋转矩阵
theta = np.deg2rad(45)
Rz = np.array([[np.cos(theta),-np.sin(theta), 0],
    [np.sin(theta), np.cos(theta), 0],
    [0, 0, 1]])
v = np.array([1, 0, 0]) # 初始向量 (1,0,0)
v_rot_matrix = Rz.dot(v)
# 使用欧拉角 (yaw=45°, pitch=0°, roll=0°) 生成旋转矩阵并变换向量
rot = R.from_euler('ZYX', [45, 0, 0], degrees=True) # ZYX即偏航-俯仰-滚转顺序
v_rot_euler = rot.apply(v)

print("旋转矩阵法得到：", np.round(v_rot_matrix, 3))
print("欧拉角转换法得到：", np.round(v_rot_euler, 3)
```