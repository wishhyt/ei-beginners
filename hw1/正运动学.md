给定关节角度theta，求末端执行器的位置和姿态。这个过程直接用矩阵乘法就可搞定，主要注意一下两个关键点。


---

# ① 基座坐标系的严谨定义与建立

**目标**：让“末端相对基座”的位姿唯一、可复现。

**定义规则（标准做法）**

1. **$\mathbf{z}_0$**：沿**第 1 个关节的运动轴**（R 关节=转轴方向；P 关节=滑动方向）。
2. **$\mathbf{x}_0$**：沿 $\mathbf{z}_0$ 与 $\mathbf{z}_1$ 的**公共法线**方向（见下）。若两轴**相交**，取它们构成平面内、与两轴都**垂直**的方向；若两轴**平行**，取任一与两轴垂直、且便于测量/安装的方向。
3. **$\mathbf{y}_0$**：按右手定则 $\mathbf{y}_0=\mathbf{z}_0\times\mathbf{x}_0$。
4. **原点 $O_0$**：放在底座几何基准（厂家 Base 点）或 $\mathbf{z}_0$ 与公共法线最近点处——只要**后续能准确测到**即可。

> 若你的“世界系”与“基座系”不同，用常量外参 ${}^{W}\!T_{B}$ 把两者关联即可。

**什么是“公共法线（common normal）”？**
给两条空间有向直线 $Z_{i-1}$ 与 $Z_i$（它们分别是第 $i$ 与第 $i+1$ 关节轴），其方向单位向量为 $\hat{\mathbf{z}}_{i-1},\hat{\mathbf{z}}_{i}$。

* 方向：$\hat{\mathbf{x}}_i=\dfrac{\hat{\mathbf{z}}_{i-1}\times\hat{\mathbf{z}}_i}{\|\hat{\mathbf{z}}_{i-1}\times\hat{\mathbf{z}}_i\|}$（若两轴平行则分母为 0，此时公共法线族无穷多，任选其一但全链保持一致）。
* 位置：取**连接两轴的最短线段**作为公共法线；若两轴**相交**，该线段长度为 0（退化）。

---

# ② DH 参数与矩阵

> 先说明**索引约定**，避免最常见的混淆：
>
> * **标准 DH（“经典 DH”）**：把**第 $i$ 个关节的轴**记作 $\mathbf{z}_{\,i-1}$。所以 $\theta_i,d_i$ 都是**绕/沿 $ \mathbf{z}_{\,i-1}$** 的。
> * **改进 DH（Craig/MDH）**：把**第 $i$ 个关节的轴**记作 $\mathbf{z}_{\,i}$。所以 $\theta_i,d_i$ 都是**绕/沿 $ \mathbf{z}_{\,i}$** 的。
>   二者等价，但**不能混用**。

**四个 DH 参数（对第 $i$ 节）**

* $a_i$：两轴 $Z_{i-1},Z_i$ 的公共法线在 $x_i$ 方向的**长度**（非负）。
* $\alpha_i$：从 $Z_{i-1}$ 旋到 $Z_{i}$ 围绕 $x_i$ 的**扭角**（带符号）。
* $d_i$：沿“**关节轴**”的**偏距**（标准 DH：沿 $z_{i-1}$；改进 DH：沿 $z_i$）。
* $\theta_i$：绕“**关节轴**”的**转角**（标准 DH：绕 $z_{i-1}$；改进 DH：绕 $z_i$）。

> 变量归属：R 关节 ⇒ $\theta_i$ 变量、$d_i$ 常量；P 关节 ⇒ $d_i$ 变量、$\theta_i$ 常量。

**坐标系的放置（推荐记法）**

* 令 $\mathbf{z}_{i-1} \parallel$ 第 $i$ 个关节轴；
* $\mathbf{x}_i \parallel$ $Z_{i-1}$ 与 $Z_i$ 的公共法线；
* $\mathbf{y}_i = \mathbf{z}_i \times \mathbf{x}_i$（右手系）。

---

## 标准 DH 的齐次变换（从 $\{i-1\}$ 到 $\{i\}$）

按序：$\mathrm{Rot}_z(\theta_i)\ \rightarrow\ \mathrm{Trans}_z(d_i)\ \rightarrow\ \mathrm{Trans}_x(a_i)\ \rightarrow\ \mathrm{Rot}_x(\alpha_i)$。

$$
{}^{i-1}\!T_{i} =
\begin{bmatrix}
\cos\theta_i & -\sin\theta_i\cos\alpha_i & \sin\theta_i\sin\alpha_i & a_i\cos\theta_i\\
\sin\theta_i & \ \cos\theta_i\cos\alpha_i & -\cos\theta_i\sin\alpha_i& a_i\sin\theta_i\\
0            & \ \sin\alpha_i             & \ \cos\alpha_i           & d_i\\
0&0&0&1
\end{bmatrix}
$$

## 改进（Craig）DH 的齐次变换（从 $\{i-1\}$ 到 $\{i\}$）

按序：$\mathrm{Rot}_x(\alpha_i)\ \rightarrow\ \mathrm{Trans}_x(a_i)\ \rightarrow\ \mathrm{Rot}_z(\theta_i)\ \rightarrow\ \mathrm{Trans}_z(d_i)$。

$$
{}^{i-1}\!T_{i} =
\begin{bmatrix}
 \cos\theta_i & -\sin\theta_i & 0 & a_i\\
 \sin\theta_i\cos\alpha_i & \cos\theta_i\cos\alpha_i & -\sin\alpha_i & -d_i\sin\alpha_i\\
 \sin\theta_i\sin\alpha_i & \cos\theta_i\sin\alpha_i & \cos\alpha_i & d_i\cos\alpha_i\\
 0&0&0&1
\end{bmatrix}
$$

**正运动学就是矩阵连乘**

$$
{}^{0}\!T_{n} = {}^{0}\!T_{1}\,{}^{1}\!T_{2}\cdots{}^{n-1}\!T_{n}
= \begin{bmatrix}\mathbf{R}_0^n & \mathbf{p}_0^n\\ \mathbf{0}^\top & 1\end{bmatrix}
$$

有外参/工具则再乘 ${}^{W}\!T_B$ 或 ${}^{n}\!T_{TCP}$。

---

# ③ 怎么“量/填/算”

1. **定轴**：画出每个关节的轴 $Z_{0},Z_{1},\dots,Z_{n-1}$（按上面索引约定）。
2. **定系**：

   * $\mathbf{z}_{0}\parallel Z_0$（基座）；
   * 对每个 $i\ge 1$：令 $\mathbf{z}_{i}\parallel Z_i$；令 $\mathbf{x}_i \parallel$ $Z_{i-1}$ 与 $Z_i$ 的公共法线；$ \mathbf{y}_i=\mathbf{z}_i\times\mathbf{x}_i$。
3. **填表**：

   * $a_i=$ 公共法线在 $x_i$ 上的长度；
   * $\alpha_i=\angle(\mathbf{z}_{i-1},\mathbf{z}_i)$ 围绕 $x_i$ 的有向角；
   * $d_i,\theta_i$ 分别是沿/绕“关节轴”的位移/转角（看你用**标准**还是**改进** DH）。
4. **连乘**：把每节的 ${}^{i-1}T_i$ 按顺序左乘，得到 ${}^{0}T_n$。
5. **取位姿**：$\mathbf{p}_0^n$ 为位置，$\mathbf{R}_0^n$ 可转欧拉角/四元数。

**三种“坑位判别”一览**

* 若 $Z_{i-1}\ \parallel\ Z_i$：$\alpha_i=0$ 或 $\pi$，$a_i$ 是两轴的水平距离。
* 若 $Z_{i-1}$ 与 $Z_i$ **相交**：$a_i=0$。
* R/P 变量别搞反：R→$\theta_i$ 变量；P→$d_i$ 变量。

---

# ④ 一个**数值示例**

设 3R 机械臂，DH 参数取：

* 关节 1：$a_1=0.30$ m，$\alpha_1=+90^\circ$，$d_1=0.40$ m，$\theta_1=0^\circ$
* 关节 2：$a_2=0.25$ m，$\alpha_2=0^\circ$，$d_2=0$，$\theta_2=90^\circ$
* 关节 3：$a_3=0.20$ m，$\alpha_3=0^\circ$，$d_3=0$，$\theta_3=0^\circ$

逐节矩阵（四舍五入成 0/1 以便手算）：

$$
{}^{0}\!T_{1}=\begin{bmatrix}
1&0&0&0.30\\
0&0&-1&0\\
0&1&0&0.40\\
0&0&0&1
\end{bmatrix},\quad
{}^{1}\!T_{2}=\begin{bmatrix}
0&-1&0&0\\
1&0&0&0.25\\
0&0&1&0\\
0&0&0&1
\end{bmatrix},\quad
{}^{2}\!T_{3}=\begin{bmatrix}
1&0&0&0.20\\
0&1&0&0\\
0&0&1&0\\
0&0&0&1
\end{bmatrix}
$$

先乘 ${}^{0}\!T_{2}={}^0\!T_1\,{}^1\!T_2$：

$$
{}^{0}\!R_{2}=\begin{bmatrix}
0&-1&0\\
0&0&-1\\
1&0&0
\end{bmatrix},\quad
{}^{0}\!\mathbf{p}_{2}=\begin{bmatrix}0.30\\0\\0.65\end{bmatrix}
$$

再乘 ${}^{0}\!T_{3}={}^0\!T_2\,{}^2\!T_3$：

$$
{}^{0}\!\mathbf{p}_{3} = {}^{0}\!R_2\,\begin{bmatrix}0.20\\0\\0\end{bmatrix} + {}^{0}\!\mathbf{p}_2
= \begin{bmatrix}0\\0\\0.20\end{bmatrix}+\begin{bmatrix}0.30\\0\\0.65\end{bmatrix}
= \boxed{\begin{bmatrix}0.30\\0\\0.85\end{bmatrix}}
$$

$$
{}^{0}\!R_{3}={}^0\!R_2\ (\text{因为 }{}^2\!R_3=I)=
\begin{bmatrix}
0&-1&0\\
0&0&-1\\
1&0&0
\end{bmatrix}
$$

因此末端相对基座的齐次矩阵：

$$
{}^{0}\!T_{3}=
\begin{bmatrix}
0&-1&0&0.30\\
0&0&-1&0\\
1&0&0&0.85\\
0&0&0&1
\end{bmatrix}
$$
